From a124ac9e9cb63de3c68d4c875dab41df8873cc67 Mon Sep 17 00:00:00 2001
From: flymyao <flymyao@gmail.com>
Date: Wed, 30 Jan 2013 19:19:18 +0800
Subject: [PATCH 6/6] add a button to show userinfo

---
 .../samplesocial/service/GithubAuthService.java    |    2 +-
 .../samplesocial/service/GithubService.java        |   19 +++++++++----------
 .../samplesocial/service/YaoGithubAuthService.java |    8 ++++++--
 .../britesnow/samplesocial/web/GitHubHandlers.java |   12 ++++++++++++
 src/main/webapp/js/GithubScreen.js                 |    7 ++++++-
 src/main/webapp/js/app.js                          |    8 ++++++++
 src/main/webapp/tmpl/GithubScreen.tmpl             |    3 ++-
 7 files changed, 44 insertions(+), 15 deletions(-)

diff --git a/src/main/java/com/britesnow/samplesocial/service/GithubAuthService.java b/src/main/java/com/britesnow/samplesocial/service/GithubAuthService.java
index 8f1e81e..6b1166f 100644
--- a/src/main/java/com/britesnow/samplesocial/service/GithubAuthService.java
+++ b/src/main/java/com/britesnow/samplesocial/service/GithubAuthService.java
@@ -49,7 +49,7 @@ public class GithubAuthService implements AuthService {
     public boolean updateAccessToken(String verifierCode, long userId) throws IOException {
         Verifier verifier = new Verifier(verifierCode);
         Token accessToken = oAuthService.getAccessToken(EMPTY_TOKEN, verifier);
-        System.out.println(accessToken.getRawResponse()+verifierCode+" "+userId);
+        System.out.println(accessToken.getRawResponse());
         if (accessToken.getToken() != null) {
             //get userinfo
             GitHubClient client = new GitHubClient();
diff --git a/src/main/java/com/britesnow/samplesocial/service/GithubService.java b/src/main/java/com/britesnow/samplesocial/service/GithubService.java
index 3a33bb2..e438150 100644
--- a/src/main/java/com/britesnow/samplesocial/service/GithubService.java
+++ b/src/main/java/com/britesnow/samplesocial/service/GithubService.java
@@ -21,25 +21,21 @@ import com.google.inject.Singleton;
 
 @Singleton
 public class GithubService {
-	private final Map appConfig;
 
 	private static String TOKEN_URL = "https://github.com/login/oauth/access_token";
-
+	private static String USER_INFO = "https://api.github.com/user";
 	@Inject
 	private YaoGithubAuthService yaoGithubAuthService;
 
 	private OAuthService oAuthService;
 
 	@Inject
-	public GithubService(@ApplicationProperties Map appConfig,OAuthServiceHelper oauthServiceHelper) {
-		this.appConfig = appConfig;
-		oAuthService = oauthServiceHelper
-				.getOauthService(ServiceType.Github);
+	public GithubService(OAuthServiceHelper oauthServiceHelper) {
+		oAuthService = oauthServiceHelper.getOauthService(ServiceType.Github);
 	}
 
 	public Token getToken(User user) {
-		SocialIdEntity soId = yaoGithubAuthService.getSocialIdEntity(user
-				.getId());
+		SocialIdEntity soId = yaoGithubAuthService.getSocialIdEntity(user.getId());
 		return new Token(soId.getToken(), soId.getSecret());
 	}
 
@@ -49,10 +45,13 @@ public class GithubService {
 		return request;
 	}
 
+	public String showUserInfo(User user){
+		return USER_INFO+"?access_token="+getToken(user).getToken();
+	}
 	public String getUserInfo(User user, String code) {
 		OAuthRequest request = createRequest(Verb.POST, TOKEN_URL);
-		 Verifier verifier = new Verifier(code);
-	     Token accessToken = oAuthService.getAccessToken(EMPTY_TOKEN, verifier);
+		Verifier verifier = new Verifier(code);
+	    Token accessToken = oAuthService.getAccessToken(EMPTY_TOKEN, verifier);
 		System.out.println( accessToken.getToken());
 		return null;
 	}
diff --git a/src/main/java/com/britesnow/samplesocial/service/YaoGithubAuthService.java b/src/main/java/com/britesnow/samplesocial/service/YaoGithubAuthService.java
index b52e282..b4e3fce 100644
--- a/src/main/java/com/britesnow/samplesocial/service/YaoGithubAuthService.java
+++ b/src/main/java/com/britesnow/samplesocial/service/YaoGithubAuthService.java
@@ -7,6 +7,7 @@ import org.scribe.oauth.OAuthService;
 import com.britesnow.samplesocial.dao.SocialIdEntityDao;
 import com.britesnow.samplesocial.entity.SocialIdEntity;
 import com.britesnow.samplesocial.oauth.OAuthServiceHelper;
+import com.britesnow.samplesocial.oauth.OauthException;
 import com.britesnow.samplesocial.oauth.ServiceType;
 import com.google.inject.Inject;
 import com.google.inject.Singleton;
@@ -20,12 +21,15 @@ public class YaoGithubAuthService implements AuthService{
 	
     @Inject
     public YaoGithubAuthService(OAuthServiceHelper oauthServiceHelper) {
-        oAuthService = oauthServiceHelper.getOauthService(ServiceType.SalesForce);
+        oAuthService = oauthServiceHelper.getOauthService(ServiceType.Github);
     }
 
 	@Override
 	public SocialIdEntity getSocialIdEntity(Long userId) {
-		return socialIdEntityDao.getSocialdentity(userId, ServiceType.Github);
+		SocialIdEntity soId = socialIdEntityDao.getSocialdentity(userId, ServiceType.Github);
+		if(soId == null)
+			throw new OauthException(getAuthorizationUrl());
+		return soId;
 	}
 	
 	public String getAuthorizationUrl() {
diff --git a/src/main/java/com/britesnow/samplesocial/web/GitHubHandlers.java b/src/main/java/com/britesnow/samplesocial/web/GitHubHandlers.java
index 3517df0..cbd2e46 100644
--- a/src/main/java/com/britesnow/samplesocial/web/GitHubHandlers.java
+++ b/src/main/java/com/britesnow/samplesocial/web/GitHubHandlers.java
@@ -2,8 +2,11 @@ package com.britesnow.samplesocial.web;
 
 import java.io.IOException;
 
+import com.britesnow.samplesocial.entity.User;
+import com.britesnow.samplesocial.service.GithubService;
 import com.britesnow.samplesocial.service.YaoGithubAuthService;
 import com.britesnow.snow.web.RequestContext;
+import com.britesnow.snow.web.param.annotation.WebUser;
 import com.britesnow.snow.web.rest.annotation.WebGet;
 import com.google.inject.Inject;
 import com.google.inject.Singleton;
@@ -14,8 +17,17 @@ public class GitHubHandlers {
 	@Inject
 	private YaoGithubAuthService yaoGithubAuthService;
 	
+	
+	@Inject
+	private GithubService githubService;
 	@WebGet("/github/connects")
 	public void auth(RequestContext rc) throws IOException{
 		  rc.getRes().sendRedirect(yaoGithubAuthService.getAuthorizationUrl());
 	}
+	
+	@WebGet("/github/user")
+	public WebResponse userAccess(RequestContext rc,@WebUser User user) throws IOException{
+		String url = githubService.showUserInfo(user);
+		return WebResponse.success(url);
+	}
 }
diff --git a/src/main/webapp/js/GithubScreen.js b/src/main/webapp/js/GithubScreen.js
index 00d75b0..fe4c3f9 100644
--- a/src/main/webapp/js/GithubScreen.js
+++ b/src/main/webapp/js/GithubScreen.js
@@ -4,8 +4,13 @@
 			return  app.render("tmpl-GithubScreen")
 		},
 		events:{
-			"click;.btn":function(event){
+			"click;.auth":function(event){
 				app.oauth.authorize("Github");
+			},
+			"click;.show":function(event){
+				app.githubApi.showUserInfo().pipe(function(url){
+					window.showModalDialog(url.result);
+				});
 			}
 		}
 	})
diff --git a/src/main/webapp/js/app.js b/src/main/webapp/js/app.js
index 00ed430..979c583 100644
--- a/src/main/webapp/js/app.js
+++ b/src/main/webapp/js/app.js
@@ -138,6 +138,14 @@ var app = app || {};
 
     };
 
+    app.githubApi={
+        showUserInfo : function(){
+        	 var params = {};
+        	 params.method = "Get";
+        	return app.getJsonData(contextPath + "/github/user",params);
+        }
+    };
+    
     app.linkedInApi = {
         getConnections: function(param){
             param = param||{};
diff --git a/src/main/webapp/tmpl/GithubScreen.tmpl b/src/main/webapp/tmpl/GithubScreen.tmpl
index e7b4b5d..1db5210 100644
--- a/src/main/webapp/tmpl/GithubScreen.tmpl
+++ b/src/main/webapp/tmpl/GithubScreen.tmpl
@@ -1,5 +1,6 @@
 <script id="tmpl-GithubScreen" type="text/html">
   <div>
-  <button class="btn btn-primary">Github Auth</button>
+  <button class="btn btn-primary auth">Github Auth</button>
+  <button class="btn btn-primary show">Show UserInfo</button>
   </div>
 </script>
\ No newline at end of file
-- 
1.7.5.1

